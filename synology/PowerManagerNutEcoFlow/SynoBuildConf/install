#!/bin/bash
# Install stage script assembles package archive within Synology build system.
# - Generates package.tgz from the staged payload.
# - Copies metadata files required for spk creation.
# - Produces the final .spk and copies it to /workspace/dist for CI to upload.
set -euo pipefail

readonly SCRIPT_PATH="${BASH_SOURCE[0]:-$0}"
readonly SCRIPT_DIR="$(cd "$(dirname "${SCRIPT_PATH}")" && pwd -P)"
readonly PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd -P)"
readonly INSTALL_ROOT="/tmp/_install"
readonly SPK_OUTPUT_DIR="/tmp/_spk_output"
readonly DIST_DIR="/workspace/dist"
readonly PACKAGE_SOURCE="${PROJECT_ROOT}/package"

# shellcheck disable=SC1091 # Provided by Synology build environment
source /pkgscripts-ng/include/pkg_util.sh

# Source INFO to obtain package metadata fields (package name, version, etc.).
# shellcheck disable=SC1091
source "${PROJECT_ROOT}/INFO"

readonly PACKAGE_NAME="${package:?package name missing in INFO}"
readonly PACKAGE_VERSION="${version:?version missing in INFO}"

declare -a PLATFORM_CANDIDATES=()
if [ -n "${PKG_ARCH:-}" ]; then
    PLATFORM_CANDIDATES+=("${PKG_ARCH}")
fi
if [ -n "${DSM_PLATFORM:-}" ]; then
    PLATFORM_CANDIDATES+=("${DSM_PLATFORM}")
fi
SPK_PLATFORM_RAW="$(pkg_get_spk_platform 2>/dev/null || true)"
if [ -n "${SPK_PLATFORM_RAW}" ]; then
    PLATFORM_CANDIDATES+=("${SPK_PLATFORM_RAW}")
fi
if declare -F pkg_get_unified_platform >/dev/null; then
    UNIFIED_PLATFORM="$(pkg_get_unified_platform 2>/dev/null || true)"
    if [ -n "${UNIFIED_PLATFORM}" ]; then
        PLATFORM_CANDIDATES+=("${UNIFIED_PLATFORM}")
    fi
fi

echo "[install] PKG_ARCH='${PKG_ARCH:-}' DSM_PLATFORM='${DSM_PLATFORM:-}' INFO_arch='${arch:-undefined}' SPK_PLATFORM_RAW='${SPK_PLATFORM_RAW:-}' UNIFIED_PLATFORM='${UNIFIED_PLATFORM:-}'"

PLATFORM=""
for candidate in "${PLATFORM_CANDIDATES[@]}"; do
    if [ -n "${candidate}" ] && [[ "${candidate}" != *"[ERROR"* ]]; then
        PLATFORM="${candidate}"
        break
    fi
done

if [ -z "${PLATFORM}" ] && [ -d "/toolkit/build_env" ]; then
    # Derive platform from build environment directory name (e.g. ds.apollolake-7.1).
    mapfile -t BUILD_DIR_ARRAY < <(find /toolkit/build_env -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null || true)
    if [ "${#BUILD_DIR_ARRAY[@]}" -gt 0 ]; then
        echo "[install] Detected build environment directories: ${BUILD_DIR_ARRAY[*]}"
        for DIR_NAME in "${BUILD_DIR_ARRAY[@]}"; do
            if [[ "${DIR_NAME}" == ds.base-* ]]; then
                continue
            fi
            PLATFORM="${DIR_NAME#ds.}"
            PLATFORM="${PLATFORM%%-*}"
            if [ -n "${PLATFORM}" ]; then
                echo "[install] Derived platform from build environment: ${PLATFORM}"
                break
            fi
        done
    else
        echo "[install] No build environment directories found under /toolkit/build_env"
    fi
fi

if [ -z "${PLATFORM}" ] && [ -n "${arch:-}" ]; then
    PLATFORM="${arch}"
    echo "[install] Falling back to INFO arch value: ${PLATFORM}"
fi

if [ -z "${PLATFORM}" ]; then
    echo "[install] ERROR: Unable to determine Synology platform architecture" >&2
    exit 1
fi

readonly PLATFORM
readonly SPK_NAME="${PACKAGE_NAME}-${PLATFORM}-${PACKAGE_VERSION}.spk"

echo "[install] Preparing install root at ${INSTALL_ROOT}"
rm -rf "${INSTALL_ROOT}"
mkdir -p "${INSTALL_ROOT}"

echo "[install] Creating package.tgz from ${PACKAGE_SOURCE}"
pkg_make_package "${PACKAGE_SOURCE}" "${INSTALL_ROOT}"

echo "[install] Copying package metadata into install root"
cp "${PROJECT_ROOT}/INFO" "${INSTALL_ROOT}/INFO"
cp "${PROJECT_ROOT}/PACKAGE_ICON.PNG" "${INSTALL_ROOT}/PACKAGE_ICON.PNG"
cp "${PROJECT_ROOT}/PACKAGE_ICON_256.PNG" "${INSTALL_ROOT}/PACKAGE_ICON_256.PNG"
cp -a "${PROJECT_ROOT}/conf" "${INSTALL_ROOT}/conf"
cp -a "${PROJECT_ROOT}/scripts" "${INSTALL_ROOT}/scripts"
if [ -d "${PROJECT_ROOT}/WIZARD_UIFILES" ]; then
    cp -a "${PROJECT_ROOT}/WIZARD_UIFILES" "${INSTALL_ROOT}/WIZARD_UIFILES"
fi

echo "[install] Generating ${SPK_NAME}"
rm -rf "${SPK_OUTPUT_DIR}"
mkdir -p "${SPK_OUTPUT_DIR}"
pkg_make_spk "${INSTALL_ROOT}" "${SPK_OUTPUT_DIR}" "${SPK_NAME}"

echo "[install] Copying ${SPK_NAME} into ${DIST_DIR}"
mkdir -p "${DIST_DIR}"
cp "${SPK_OUTPUT_DIR}/${SPK_NAME}" "${DIST_DIR}/${SPK_NAME}"

echo "[install] Install stage completed successfully"

exit 0

